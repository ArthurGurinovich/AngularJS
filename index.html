<!DOCTYPE html>
<html lang="en">
    <head>
        <title>AngularJS | Course</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" href="./img/favicon.ico" type="image/x-icon">
        <link rel="shortcut icon" href="./img/favicon.ico" type="image/x-icon">
        <script src="./js/base/angular.min.1.5.js"></script>
        <link rel="stylesheet" type="text/css" href="./css/style.css">
    </head>
    <body>
        <header class="top-header">
            <div class="logo">
                <img src="./img/angular.svg"/>
            </div>
            <div class="title">AngularJS | Training</div>
        </header>
        <div id="content">
            <div class="lesson">
                <div class="title">Lesson 5 - Services and Providers </div>
                <div class="description">
                    <div ng-app="myApp">
                        <div ng-controller="myController">
                            <div class="login_form" ng-if="loginForm.state">
                                <p>{{ loginForm.title }}</p>
                                <input type="text" name="username" value="" ng-model="loginForm.user.name" placeholder="Введите Ваше имя">
                                <input type="text" name="position" value="" ng-model="loginForm.user.position" placeholder="Ваша профессия">
                                <input type="button" name="start" value="Войти" ng-click="startChat()">
                            </div>
                            <div ng-if="!loginForm.state">
                                <chat setting="{{ loginForm }}">
                                    <messages>
                                    </messages>
                                    <form-chat></form-chat>
                                </chat>
                            </div>
                        </div>
                    </div>
                    <script>
                        var app = angular.module("myApp", []);
                        app.config(function(consultProvider) {
                            var consultation = [
                                'Hi! Nice to meet you',
                                'How are you?',
                                'Not too bad, thanks',
                                'What do you do?',
                                'That\'s awesome',
                                'I think you\'re a nice person',
                                'Why do you think that?',
                                'Can you explain?',
                                'Anyway I\'ve gotta go now',
                                'It was a pleasure chat with you',
                                'Bye'
                            ];
                            consultProvider.setAnswers(consultation);
                        });   
                        app.provider('consult', function() {
                          var answers = ['Answer1', 'Answer2'];
                          return {
                            setAnswers: function(data) {
                              answers = data;
                            },
                            $get: function() {
                              function getAnswers() {
                                return answers;
                              }
                              return {
                                variable: "Test",
                                getAnswers: getAnswers
                              };
                            }
                          };
                        });                     
                        // Init Main Controller
                        app.service('myMessages',['consult','$timeout', function(consult, $timeout){
                            var self = this;
                            this.messages = [];
                            this.counter = 0;
                            this.addMessage = function(text){
                                if((text !== '') || (text !== undefined)){
                                    self.counter++;
                                    var data = {
                                            message: text,
                                            time: new Date(),
                                            client: true,
                                            id: self.counter
                                        };
                                    self.messages.push(data);
                                    self.getConsult();
                                    console.log(self.messages);
                                }else{
                                    console.info("Wrong message value!");
                                }
                            };
                            this.sendMessage = function(){
                                return self.messages.length;
                            };
                            this.getConsult = function(){
                                self.counter++;
                                this.answers = consult.getAnswers();
                                var data = {
                                        message: this.answers[(self.counter-2)],
                                        time: new Date(),
                                        client: false,
                                        id: self.counter
                                };
                                $timeout(function(){
                                    self.messages.push(data)   
                                }, 1500);  
                            };
                            this.getHistory = function(){
                                return self.messages.length;
                            };
                        }]);
                        app.controller("myController", ['$scope','myMessages', function($scope, myMessages) {
                            $scope.loginForm = {
                                title: 'Введите ваше имя для начала консультации',
                                state: true,
                                user: {
                                    name: '',
                                    position: '',
                                    countMessage: 0 
                                }
                            };

                            $scope.startChat = function(){
                                $scope.loginForm.state = false;
                            };
                            $scope.loginForm.user.countMessage = myMessages.getHistory();
                        }]);
                        app.controller('chatCtrl', function($scope, $element, $attrs) {
                            $scope.initUser = function(setting, param){
                                var init = JSON.parse(setting);
                                switch (param) {
                                  case 'name':
                                    return init.user.name;
                                    break;
                                  case 'position':
                                    return init.user.position;
                                    break;
                                  case 'countMessage':
                                    return init.user.countMessage;
                                    break;
                                  default:
                                    return 'User info';
                                }
                            };
                        });
                        app.directive('chat', function(){
                            return {
                                scope: {
                                    setting: '@'
                                },
                                controller: 'chatCtrl',
                                restrict: 'E',
                                template: '<div class="chat">' +
                                            '<div class="chat-title">' +
                                                '<h1>{{ initUser(setting, "name") }}</h1>' +
                                                '<h2>{{  initUser(setting, "position") }}</h2>' +
                                                '<figure class="avatar">' +
                                                    '<img src="./img/user.png"/><i class="counter">{{  initUser(setting, "countMessage") }}</i>' +
                                                '</figure>' +
                                            '</div>' +
                                            '<ng-transclude></ng-transclude>' +
                                        '</div>',
                                transclude: true
                            };
                        });
                        app.controller('messagesCtrl', function($rootScope, $scope, $element, $attrs, $timeout, myMessages) {
                            var messages = $scope.messages = [];
                            $scope.messages = myMessages.messages;
                        });
                        app.directive('messages', function(){
                            return {
                                scope: {
                                    messages: '@',
                                },
                                controller: 'messagesCtrl',
                                restrict: 'E',
                                template: '<div class="messages">'+
                                            '<div class="messages-content">'+
                                                '<div class="message2" ng-repeat="x in messages"><div ng-show="!x.client" class="message message-other">{{ x.message }}<div class="timestamp">{{ x.time | date:\'h:mm\'}}</div></div><div ng-show="x.client" class="message message-personal">{{ x.message }} <div class="timestamp">{{ x.time | date:\'h:mm\'}}</div></div></div>'+
                                                '<div class="message-other"></div>'+
                                            '</div>'+
                                        '</div>',
                                transclude: true
                            };
                        });
                        app.controller('formChatCtrl', function($rootScope, $scope, $element, $attrs, myMessages) {
                            $scope.addMessage = function(data){
                                $scope.message.text = '';
                                myMessages.addMessage(data);
                            };
                        });
                        app.directive('formChat', function(){
                            return {
                                scope: {

                                },
                                controller: 'formChatCtrl',
                                restrict: 'E',
                                template: '<div class="message-box">'+
                                                '<textarea type="text" ng-model="message.text" class="message-input" placeholder="Введите сообщение..."></textarea>'+
                                                '<button type="submit" class="message-submit" ng-click="addMessage(message.text)">Отправить</button>'+
                                            '</div>',
                                replace: true,
                                transclude: true,
                            };
                        });
                    </script>
                </div>   
            </div>
        </div> 
    </body>
</html>